<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clean Call — Video & Voice</title>
<!-- Minimal, clean black & white style -->
<style>
  :root{
    --bg:#ffffff;
    --fg:#0b0b0b;
    --muted:#666;
    --accent:#000;
    --card:#f8f8f8;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{display:flex;align-items:center;justify-content:center;background:var(--bg);color:var(--fg);}
  .wrap{width:100%;max-width:920px;padding:28px;box-sizing:border-box;text-align:center;}
  .card{background:var(--card);border-radius:14px;padding:28px;box-shadow:0 6px 24px rgba(0,0,0,0.06);}
  h1{margin:0 0 12px;font-size:22px;letter-spacing:0.2px;}
  p.sub{margin:0 0 18px;color:var(--muted);font-size:14px;}
  .center{
    display:flex;align-items:center;justify-content:center;gap:18px;margin:18px 0 22px;
  }
  .btn{
    min-width:160px;padding:14px 20px;border-radius:12px;border:2px solid var(--fg);
    background:transparent;color:var(--fg);font-weight:600;cursor:pointer;font-size:16px;
    transition:transform .12s ease,background .12s ease;
  }
  .btn:hover{transform:translateY(-3px)}
  .btn.black{background:var(--fg);color:var(--bg);}
  .small{font-size:13px;color:var(--muted);margin-top:12px}
  .info{margin-top:14px;font-size:13px;color:var(--muted);}
  .row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  #linkBox{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;}
  input.link{padding:10px 12px;border-radius:8px;border:1px solid #ddd;width:360px;background:white}
  .copy{padding:10px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
  .videos{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:20px}
  video{background:#000;border-radius:8px;max-width:420px;width:100%;height:auto;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
  .muted{opacity:.9;color:var(--muted);font-size:13px;margin-top:8px}
  .actions{margin-top:16px}
  .danger{background:#fff;border:2px solid #ff3b30;color:#ff3b30}
  footer{margin-top:18px;font-size:12px;color:var(--muted)}
  @media (max-width:600px){
    .wrap{padding:18px}
    input.link{width:100%}
    .btn{min-width:130px;padding:12px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Clean Call — Video & Voice</h1>
      <p class="sub">Open, simple UI. Middle main buttons: start a Video or Voice call → get shareable link. Others open link to join.</p>

      <div id="controls" class="center">
        <button id="startVideo" class="btn black">Video Call</button>
        <button id="startVoice" class="btn">Voice Call</button>
      </div>

      <div id="status" class="small"></div>

      <div id="linkArea" style="display:none">
        <div id="linkBox">
          <input id="roomLink" class="link" readonly />
          <button id="copyBtn" class="copy">Copy Link</button>
        </div>
        <div class="muted">Share this link with people you want to add. They will auto-join when they open it.</div>
      </div>

      <div class="videos" id="videos"></div>

      <div class="actions">
        <div class="row">
          <button id="hangup" class="btn danger" style="display:none">Hang Up</button>
          <button id="leave" class="btn" style="display:none">Leave Call</button>
        </div>
      </div>

      <div class="info" id="infoText">Tips: Use Chrome/Firefox on HTTPS. Allow camera & mic when asked. This is a peer-to-peer demo.</div>
      <footer>Made simple • Demo • Peer-to-Peer</footer>
    </div>
  </div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
(async function(){
  // helpers
  const $ = id => document.getElementById(id);
  const params = new URLSearchParams(window.location.search);
  const joinRoom = params.get('room'); // host peer id to join
  const callTypeParam = params.get('type'); // video | voice
  const videosEl = $('videos');
  const statusEl = $('status');
  const linkArea = $('linkArea');
  const roomLinkInput = $('roomLink');
  const copyBtn = $('copyBtn');
  const hangupBtn = $('hangup');
  const leaveBtn = $('leave');
  const startVideoBtn = $('startVideo');
  const startVoiceBtn = $('startVoice');

  let peer = null;
  let localStream = null;
  const remoteStreams = new Map(); // callId -> stream
  const activeCalls = new Map(); // callId -> call object

  function logStatus(txt){
    statusEl.textContent = txt || '';
  }

  function addVideoEl(stream, label){
    const id = Math.random().toString(36).slice(2,9);
    const container = document.createElement('div');
    container.dataset.streamId = id;
    const v = document.createElement('video');
    v.autoplay = true; v.playsInline = true;
    v.srcObject = stream;
    // If audio-only, show small placeholder
    if(stream.getVideoTracks().length === 0){
      v.style.height = '80px';
      v.style.width = '160px';
      v.poster = '';
    }
    container.appendChild(v);
    if(label){
      const lbl = document.createElement('div');
      lbl.textContent = label;
      lbl.style.fontSize = '13px';
      lbl.style.color = '#555';
      lbl.style.marginTop='6px';
      lbl.style.textAlign='center';
      container.appendChild(lbl);
    }
    videosEl.appendChild(container);
    return container;
  }

  function removeAllRemote(){
    videosEl.innerHTML = '';
  }

  function setupPeerEvents(){
    if(!peer) return;
    peer.on('open', id => {
      logStatus('Your ID: ' + id);
    });

    // answer incoming calls (when you're host)
    peer.on('call', call => {
      console.log('Incoming call', call);
      // store
      activeCalls.set(call.peer + '-' + Date.now(), call);
      // Answer with our local stream
      if(!localStream){
        // default to media capture depending on prior choice (if type saved)
        navigator.mediaDevices.getUserMedia({video:true,audio:true})
          .then(s => {
            localStream = s;
            call.answer(localStream);
            bindCallEvents(call);
            addVideoEl(localStream,'You (local)');
          }).catch(err => {
            console.error('getUserMedia failed', err);
            call.answer(); // answer without stream (audio only or empty)
            bindCallEvents(call);
          });
      } else {
        call.answer(localStream);
        bindCallEvents(call);
      }
    });

    peer.on('disconnected', ()=> logStatus('Disconnected from Peer server.'));
    peer.on('error', err => {
      console.error('Peer error', err);
      logStatus('Error: ' + (err && err.message) );
    });
  }

  function bindCallEvents(call){
    call.on('stream', remoteStream => {
      // show remote stream if not already
      if(!remoteStreams.has(call.peer)){
        remoteStreams.set(call.peer, remoteStream);
        addVideoEl(remoteStream, 'Remote: ' + call.peer);
      }
    });
    call.on('close', ()=> {
      console.log('call closed', call.peer);
      // remove corresponding video
      // simple approach: rebuild list excluding streams still present
      // remove the peer
      remoteStreams.delete(call.peer);
      activeCalls.delete(call.peer);
      // clear UI and re-add local + remaining remotes
      const savedLocal = localStream;
      removeAllRemote();
      if(savedLocal) addVideoEl(savedLocal,'You (local)');
      for(const [p,s] of remoteStreams) addVideoEl(s,'Remote: '+p);
    });
    call.on('error', err => console.error('Call error', err));
  }

  copyBtn.addEventListener('click', ()=> {
    if(roomLinkInput.value) navigator.clipboard.writeText(roomLinkInput.value).then(()=> {
      copyBtn.textContent = 'Copied!';
      setTimeout(()=> copyBtn.textContent = 'Copy Link',1200);
    });
  });

  hangupBtn.addEventListener('click', ()=> {
    // close all calls and destroy peer
    for(const c of activeCalls.values()){
      try{ c.close(); }catch(e){}
    }
    activeCalls.clear();
    remoteStreams.clear();
    if(peer){
      try{ peer.destroy(); } catch(e){}
      peer = null;
    }
    if(localStream){
      localStream.getTracks().forEach(t=>t.stop());
      localStream = null;
    }
    removeAllRemote();
    logStatus('Call ended.');
    linkArea.style.display = 'none';
    hangupBtn.style.display = 'none';
    leaveBtn.style.display = 'none';
  });

  leaveBtn.addEventListener('click', ()=> {
    // just leave (close local tracks but keep peer?), simpler: same as hangup
    hangupBtn.click();
  });

  // Start as host (create room) for video or voice
  async function startAsHost(type){
    // create Peer
    peer = new Peer(undefined, {
      // default PeerServer - demo. For production use your own PeerServer.
      // host: 'peerjs.com', port: 443, secure: true
    });
    setupPeerEvents();

    try{
      const constraints = (type === 'video') ? {video:{width:{ideal:1280}}, audio:true} : {audio:true};
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      addVideoEl(localStream, 'You (local)');
    }catch(err){
      console.warn('Media capture failed or blocked', err);
      // continue without local stream
      localStream = null;
    }

    peer.on('open', id => {
      const link = `${window.location.origin}${window.location.pathname}?room=${encodeURIComponent(id)}&type=${encodeURIComponent(type)}`;
      roomLinkInput.value = link;
      linkArea.style.display = 'block';
      logStatus('Room ready. Share the link to invite people.');
      hangupBtn.style.display = 'inline-block';
      leaveBtn.style.display = 'inline-block';
    });

    // when new peer connects and calls, .on('call') will answer (see setupPeerEvents)
  }

  // join an existing room (you are visitor)
  async function joinRoomAsVisitor(hostId, type){
    // create our peer
    peer = new Peer(undefined);
    setupPeerEvents();

    try{
      const constraints = (type === 'video') ? {video:{width:{ideal:1280}}, audio:true} : {audio:true};
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      addVideoEl(localStream, 'You (local)');
    }catch(err){
      console.warn('Media capture failed', err);
      localStream = null;
    }

    peer.on('open', id => {
      logStatus('Joining room: ' + hostId + ' ...');
      // call the host
      const call = peer.call(hostId, localStream);
      if(!call){
        logStatus('Call failed or host not available.');
        return;
      }
      activeCalls.set(call.peer, call);
      bindCallEvents(call);
      hangupBtn.style.display = 'inline-block';
      leaveBtn.style.display = 'inline-block';
    });
  }

  // Button behaviors
  startVideoBtn.addEventListener('click', ()=> {
    // create a room of type video
    startAsHost('video');
    // hide start buttons to avoid multiple creates
    startVideoBtn.disabled = true; startVoiceBtn.disabled = true;
    startVideoBtn.style.opacity = .7; startVoiceBtn.style.opacity = .7;
  });
  startVoiceBtn.addEventListener('click', ()=> {
    startAsHost('voice');
    startVideoBtn.disabled = true; startVoiceBtn.disabled = true;
    startVideoBtn.style.opacity = .7; startVoiceBtn.style.opacity = .7;
  });

  // Auto-join if URL has room param
  if(joinRoom){
    // immediately start joining as visitor
    // hide the main buttons
    startVideoBtn.style.display = 'none';
    startVoiceBtn.style.display = 'none';
    // small message
    logStatus('Auto-joining room...');
    try{
      await joinRoomAsVisitor(joinRoom, callTypeParam === 'voice' ? 'voice' : 'video');
    }catch(e){
      console.error(e);
      logStatus('Failed to join room: ' + e.message);
    }
  }

  // quick UI hint if user wants to manually paste an ID (optional)
  // if the user wants, they can paste a ?room= link and reload.

  // end IIFE
})();
</script>
</body>
</html>
