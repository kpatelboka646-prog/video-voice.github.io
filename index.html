<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clean Call — Video & Voice (Glass UI)</title>
<!-- Single-file clean black & white + glass UI with join, record, improved UX -->
<style>
  /* --- Base (minimal, readable) --- */
  :root{
    --bg:#f5f6f7; /* subtle light */
    --glass-bg: rgba(255,255,255,0.55);
    --accent:#000;
    --muted:#6b6b6b;
    --success:#0a8f4a;
    --danger:#ff3b30;
    --radius:16px;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial}
  body{
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,#eef2f5 0%, #f8f9fb 50%);
    color:var(--accent);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* background subtle glassy pattern */
  .page-wrap{width:100%;max-width:980px;padding:28px;box-sizing:border-box}
  .glass {
    background: var(--glass-bg);
    border-radius:var(--radius);
    padding:26px;box-shadow:0 8px 30px rgba(12,12,12,0.08);
    backdrop-filter: blur(10px) saturate(120%);
    -webkit-backdrop-filter: blur(10px) saturate(120%);
    border:1px solid rgba(255,255,255,0.6);
  }

  .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{font-weight:700;font-size:18px;letter-spacing:0.2px}
  .subtitle{font-size:13px;color:var(--muted)}

  .center{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:14px}
  .big-buttons{display:flex;gap:12px;align-items:center}

  .btn{
    min-width:140px;padding:12px 16px;border-radius:12px;border:1px solid rgba(0,0,0,0.08);
    background:transparent;color:var(--accent);font-weight:700;cursor:pointer;font-size:15px;
    box-shadow:0 4px 12px rgba(12,12,12,0.04);transition:transform .12s ease,opacity .12s ease;
  }
  .btn:hover{transform:translateY(-4px)}
  .btn.primary{background:#000;color:#fff}
  .btn.ghost{background:transparent}
  .btn.warn{border-color:var(--danger);color:var(--danger)}

  /* Join input */
  .join-row{display:flex;gap:8px;align-items:center;margin-top:10px}
  input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid #e6e6e6;min-width:280px}

  /* videos area */
  .videos{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:18px}
  .vid-card{background:rgba(0,0,0,0.02);border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;min-width:180px}
  video{border-radius:10px;max-width:360px;width:320px;height:auto;background:#000}
  .label{font-size:13px;color:var(--muted);margin-top:8px}

  /* controls row */
  .controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:14px}

  .info{margin-top:10px;text-align:center;color:var(--muted);font-size:13px}
  footer{margin-top:16px;text-align:center;font-size:12px;color:var(--muted)}

  /* small screens */
  @media (max-width:640px){
    .big-buttons{flex-direction:column}
    input[type=text]{min-width:140px; width:100%}
    video{width:100%;max-width:100%}
  }
</style>
</head>
<body>
  <div class="page-wrap">
    <div class="glass">
      <div class="header">
        <div>
          <div class="brand">Clean Call — Glass UI</div>
          <div class="subtitle">Simple, minimal — click to start or paste a room link to join</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:var(--muted)">Demo • P2P (PeerJS)</div>
        </div>
      </div>

      <div class="center">
        <div class="big-buttons">
          <button id="startVideo" class="btn primary">Start Video</button>
          <button id="startVoice" class="btn">Start Voice</button>
          <button id="joinBtn" class="btn ghost">Join by ID / Link</button>
        </div>

        <div class="join-row" id="joinRow" style="display:none">
          <input id="joinInput" type="text" placeholder="Paste room link or ID here (example: ?room=abc...)" />
          <button id="joinNow" class="btn primary">Join</button>
        </div>

        <div id="status" class="info">Open the page, click Start Video/Voice to create a room. Share link to invite others.</div>

        <div id="linkArea" style="display:none;margin-top:8px;flex-direction:column;align-items:center">
          <input id="roomLink" type="text" readonly style="padding:8px 10px;border-radius:8px;border:1px solid #e9e9e9;width:100%" />
        </div>

        <div class="videos" id="videos"></div>

        <div class="controls">
          <button id="recordBtn" class="btn">Start Recording</button>
          <button id="hangup" class="btn warn" style="display:none">End Call</button>
          <a id="downloadLink" style="display:none;text-decoration:none" class="btn">Download Recording</a>
        </div>

        <div id="tips" class="info">Use HTTPS / localhost. Allow camera & mic. Recording captures combined available tracks where possible.</div>
      </div>

      <footer>Made simple • For production add TURN/SFU & custom PeerServer</footer>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const startVideoBtn = $('startVideo');
    const startVoiceBtn = $('startVoice');
    const joinBtn = $('joinBtn');
    const joinRow = $('joinRow');
    const joinInput = $('joinInput');
    const joinNow = $('joinNow');
    const status = $('status');
    const linkArea = $('linkArea');
    const roomLink = $('roomLink');
    const videos = $('videos');
    const recordBtn = $('recordBtn');
    const hangupBtn = $('hangup');
    const downloadLink = $('downloadLink');

    let peer = null;
    let localStream = null;
    const remoteStreams = new Map();
    const calls = new Map();

    let mediaRecorder = null;
    let recordedChunks = [];

    function setStatus(t){ status.textContent = t || ''; }

    function clearVideos(){ videos.innerHTML = ''; }
    function addVideoEl(stream, label){
      const c = document.createElement('div'); c.className='vid-card';
      const v = document.createElement('video'); v.autoplay = true; v.playsInline = true; v.srcObject = stream; v.muted = label && label.toLowerCase().includes('you');
      c.appendChild(v);
      const lab = document.createElement('div'); lab.className='label'; lab.textContent = label || '';
      c.appendChild(lab);
      videos.appendChild(c);
      return c;
    }

    function rebuildVideoTiles(){
      clearVideos();
      if(localStream) addVideoEl(localStream, 'You (local)');
      for(const [id, s] of remoteStreams) addVideoEl(s, 'Remote: ' + id);
    }

    function stopLocalStream(){ if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; } }

    function setupPeerEvents(){
      if(!peer) return;
      peer.on('open', id => {
        setStatus('Your ID: ' + id);
      });

      // host answering incoming calls
      peer.on('call', call => {
        console.log('incoming call', call.peer);
        // answer with our current localStream if available
        const answerStreamPromise = localStream ? Promise.resolve(localStream) : navigator.mediaDevices.getUserMedia({video:true,audio:true}).catch(()=>null);
        answerStreamPromise.then(s => {
          if(s){ localStream = s; rebuildVideoTiles(); }
          try{ call.answer(s); }catch(e){ console.warn('answer failed', e); }
          bindCall(call);
        });
      });

      peer.on('disconnected', ()=> setStatus('Disconnected'));
      peer.on('error', err => { console.error(err); setStatus('Peer error: '+ (err && err.message)); });
    }

    function bindCall(call){
      calls.set(call.peer, call);
      call.on('stream', remoteStream => {
        remoteStreams.set(call.peer, remoteStream);
        rebuildVideoTiles();
      });
      call.on('close', ()=>{ remoteStreams.delete(call.peer); calls.delete(call.peer); rebuildVideoTiles(); });
      call.on('error', err=>{ console.error('call error', err); });
    }

    function createPeerAndLocal(type){
      return new Promise(async (resolve, reject) => {
        peer = new Peer(undefined, {});
        setupPeerEvents();
        try{
          const constraints = type==='video' ? {video:{width:{ideal:1280}}, audio:true} : {audio:true};
          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          rebuildVideoTiles();
        }catch(e){ console.warn('media capture failed', e); localStream = null; }
        peer.on('open', id => resolve(id));
        peer.on('error', err=> reject(err));
      });
    }

    async function startAsHost(type){
      try{
        const id = await createPeerAndLocal(type);
        const fullLink = location.origin + location.pathname + '?room=' + encodeURIComponent(id) + '&type=' + encodeURIComponent(type);
        roomLink.value = fullLink; linkArea.style.display='block';
        setStatus('Room created. Share link. ID: ' + id);
        hangupBtn.style.display='inline-block';
      }catch(e){ console.error(e); setStatus('Failed to create room: ' + (e&&e.message)); }
    }

    async function joinRoom(raw){
      // parse raw: if it's a full url with ?room=..., extract; else treat as id
      let hostId = raw || '';
      try{
        const u = new URL(raw);
        const p = new URLSearchParams(u.search);
        hostId = p.get('room') || hostId;
      }catch(e){ /* not a URL, maybe plain id */ }
      if(!hostId){ setStatus('Invalid room/link'); return; }

      peer = new Peer(undefined, {});
      setupPeerEvents();
      try{
        const type = (raw && raw.includes('type=voice')) ? 'voice' : 'video';
        const constraints = type==='video' ? {video:{width:{ideal:1280}}, audio:true} : {audio:true};
        try{ localStream = await navigator.mediaDevices.getUserMedia(constraints); }catch(e){ console.warn('getUserMedia failed', e); localStream = null; }

        peer.on('open', id => {
          setStatus('Calling host: ' + hostId);
          const call = peer.call(hostId, localStream);
          if(!call){ setStatus('Call could not be placed. Host may be offline.'); return; }
          bindCall(call);
          hangupBtn.style.display='inline-block';
        });
      }catch(e){ console.error(e); setStatus('Join failed: ' + (e && e.message)); }
    }

    // Recording: combine tracks (local + all remote audio/video tracks) into a single stream and record
    function startRecording(){
      recordedChunks = [];
      // gather tracks
      const tracks = [];
      if(localStream){ localStream.getTracks().forEach(t=>tracks.push(t.clone ? t.clone() : t)); }
      for(const s of remoteStreams.values()){
        s.getTracks().forEach(t=>tracks.push(t.clone ? t.clone() : t));
      }
      if(tracks.length===0){ setStatus('No tracks available to record'); return; }
      const mixedStream = new MediaStream(tracks);
      try{
        mediaRecorder = new MediaRecorder(mixedStream, {mimeType: 'video/webm;codecs=vp8,opus'});
      }catch(e){
        try{ mediaRecorder = new MediaRecorder(mixedStream); }catch(err){ console.error('MediaRecorder unsupported', err); setStatus('Recording unsupported in this browser'); return; }
      }
      mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) recordedChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, {type:'video/webm'});
        const url = URL.createObjectURL(blob);
        downloadLink.href = url; downloadLink.download = 'call-recording.webm'; downloadLink.style.display='inline-block'; downloadLink.textContent='Download Recording';
        setStatus('Recording stopped. Download ready.');
      };
      mediaRecorder.start(1000);
      setStatus('Recording...');
      recordBtn.textContent = 'Stop Recording';
    }

    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      mediaRecorder = null; recordBtn.textContent='Start Recording';
    }

    // hangup
    function endCall(){
      for(const c of calls.values()){ try{ c.close(); }catch(e){} }
      calls.clear(); remoteStreams.clear();
      if(peer){ try{ peer.destroy(); }catch(e){} peer=null; }
      stopLocalStream(); rebuildVideoTiles();
      hangupBtn.style.display='none'; linkArea.style.display='none';
      setStatus('Call ended.');
    }

    // UI wiring
    startVideoBtn.addEventListener('click', ()=>{ startAsHost('video'); startVideoBtn.disabled=true; startVoiceBtn.disabled=true; });
    startVoiceBtn.addEventListener('click', ()=>{ startAsHost('voice'); startVideoBtn.disabled=true; startVoiceBtn.disabled=true; });

    joinBtn.addEventListener('click', ()=>{ joinRow.style.display = joinRow.style.display==='none' ? 'flex' : 'none'; });
    joinNow.addEventListener('click', ()=>{ const v = joinInput.value.trim(); if(v) joinRoom(v); });

    recordBtn.addEventListener('click', ()=>{
      if(recordBtn.textContent.includes('Start')) startRecording(); else stopRecording();
    });

    hangupBtn.addEventListener('click', ()=> endCall());

    // Auto-join if URL has ?room=...
    (function autoJoinFromUrl(){
      const params = new URLSearchParams(location.search);
      const room = params.get('room');
      if(room){ // auto-join
        setStatus('Auto-joining room...');
        // hide start buttons
        startVideoBtn.style.display='none'; startVoiceBtn.style.display='none';
        joinRoom(location.href);
      }
    })();
  })();
  </script>
</body>
</html>